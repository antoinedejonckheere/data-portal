<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>Create a heatmap layer</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
    <script src="https://api.mapbox.com/mapbox-gl-js/v1.11.1/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v1.11.1/mapbox-gl.css" rel="stylesheet" />
    <style>
        body {
            margin: 0;
            padding: 0;
        }

        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
        }

        .map-overlay {
            font: 12px/20px 'Helvetica Neue', Arial, Helvetica, sans-serif;
            background-color: #fff;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            border-radius: 3px;
            position: absolute;
            width: 25%;
            top: 10px;
            left: 10px;
            padding: 10px;
            display: none;
        }
    </style>
</head>

<body>
    <div id="map"></div>
    <div id="map-overlay" class="map-overlay"></div>

    <script>
        var map = new mapboxgl.Map({
            container: 'map',
            //style: 'https://api.maptiler.com/maps/3327a63f-c15d-462a-9f23-ebf73a14254a/style.json?key=2Piy1GKXoXq0rHzzBVDA',
            style: 'https://api.maptiler.com/maps/7e7e2443-1c41-46d0-813c-f6b11c2c0225/style.json?key=2Piy1GKXoXq0rHzzBVDA',
            center: [4.3525, 50.8454],
            zoom: 14,
            hash: true,
            maxZoom: 17
        });

        map.addControl(new mapboxgl.NavigationControl());

        var overlay = document.getElementById('map-overlay');
        var popup = new mapboxgl.Popup({
            closeButton: false
        });

        map.on('load', function () {

            // get lowest label and road.
            var style = map.getStyle();
            var lowestRoad = undefined;
            var lowestLabel = undefined;
            var lowestSymbol = undefined;
            for (var l = 0; l < style.layers.length; l++) {
                var layer = style.layers[l];

                if (layer && layer["source-layer"] === "transportation") {
                    if (!lowestRoad) {
                        lowestRoad = layer.id;
                    }
                }

                if (layer && layer["source-layer"] === "transportation_name") {
                    if (!lowestLabel) {
                        lowestLabel = layer.id;
                    }
                }

                if (layer && layer.type == "symbol") {
                    if (!lowestSymbol) {
                        lowestSymbol = layer.id;
                    }
                }
            }

            map.addSource("earthquakes", {
                type: 'vector',
                //url: 'https://bikedataproject.github.io/heatmap-experiment/mvt.json',
                //url: 'http://localhost:8081/tiles/mvt-local.json'
                url: 'https://api.bikedataproject.org/tiles/heatmap/mvt.json'
            });

            var factor = 2;
            map.addLayer(
                {
                    'id': 'earthquakes-heat',
                    'type': 'heatmap',
                    'source': 'earthquakes',
                    'source-layer': 'heatmap',
                    'visibility': 'none',
                    'paint': {
                        // Increase the heatmap weight based on frequency and property magnitude
                        'heatmap-weight': [
                            'interpolate',
                            ['linear'],
                            ['zoom'],
                            0,
                            ['/', ['get', 'cost'], factor * 100000000],
                            10,
                            ['/', ['get', 'cost'], factor * 10000000],
                            14,
                            ['/', ['get', 'cost'], factor * 10000],
                            20,
                            ['/', ['get', 'cost'], factor * 100]
                            ],
                        // Increase the heatmap color weight weight by zoom level
                        // heatmap-intensity is a multiplier on top of heatmap-weight
                        'heatmap-intensity': [
                            'interpolate',
                            ['linear'],
                            ['zoom'],
                            0,
                            1,
                            12,
                            1,
                            20,
                            6
                        ],
                        // Color ramp for heatmap.  Domain is 0 (low) to 1 (high).
                        // Begin color ramp at 0-stop with a 0-transparancy color
                        // to create a blur-like effect.
                        'heatmap-color': [
                            'interpolate',
                            ['linear'],
                            ['heatmap-density'],
                            0,
                            'rgba(33,102,172,0)',
                            0.4,
                            'rgb(103,169,207)',
                            0.7,
                            'rgb(255,0,0)',
                            1,
                            'rgba(255,220,75, 1)'
                        ],
                        // Adjust the heatmap radius by zoom level
                        'heatmap-radius': [
                            'interpolate',
                            ['linear'],
                            ['zoom'],
                            0,
                            2,
                            14,
                            8,
                            20,
                            20
                        ],
                        // Transition from heatmap to circle layer by zoom level
                        'heatmap-opacity': [
                            'interpolate',
                            ['linear'],
                            ['zoom'],
                            0,
                            0.9,
                            7,
                            0.9,
                            20,
                            1
                        ]
                    }
                }, lowestSymbol
            );

            // map.addSource("areas", {
            //     type: 'vector',
            //     //url: 'https://api.bikedataproject.info/statistics/tiles/mvt-prod.json',
            //     //url: 'https://bikedataproject.github.io/heatmap-experiment/areas/mvt.json'
            //     url: 'http://localhost:8081/areas/mvt-local.json'
            // });

            // map.addLayer({
            //     'id': 'areas-stats',
            //     'type': 'fill',
            //     'source': 'areas',
            //     'source-layer': 'areas',
            //     'paint': {
            //         'fill-color': '#ffd700',
            //         'fill-opacity': 0.1
            //     }
            // });

            // map.addLayer({
            //     'id': 'areas-stats-boundaries',
            //     'type': 'line',
            //     'source': 'areas',
            //     'source-layer': 'areas',
            //     'layout': {
            //         'line-join': 'round',
            //         'line-cap': 'round'
            //     },
            //     'paint': {
            //         'line-color': '#ffd700',
            //         'line-width': 1
            //     }
            // });

            // map.addLayer(
            //     {
            //         'id': 'areas-stats-selected',
            //         'type': 'fill',
            //         'source': 'areas',
            //         'source-layer': 'areas',
            //         'paint': {
            //             'fill-outline-color': '#484896',
            //             'fill-color': '#6e599f',
            //             'fill-opacity': 0.75
            //         },
            //         'filter': ['in', 'id', '']
            //     }, 'areas-stats-boundaries');

            // map.on('mousemove', 'areas-stats', function (e) {

            //     map.getCanvas().style.cursor = 'pointer';

            //     var feature = e.features[0];
            //     console.log(feature);

            //     overlay.innerHTML = '';
                
            //     var title = document.createElement('strong');
            //     title.textContent =
            //         feature.properties.name;

            //     var population = document.createElement('div');
            //     population.textContent =
            //         'Total KMs: ' + feature.properties.km + ' ' +                    
            //         'Total Time: ' + feature.properties.seconds + ' ' +                    
            //         'Total Trips: ' + feature.properties.count;

            //     overlay.appendChild(title);
            //     overlay.appendChild(population);
            //     overlay.style.display = 'block';

            //     map.setFilter('areas-stats-selected', [
            //         'in',
            //         'id',
            //         feature.properties.id
            //     ]);

            //     popup
            //         .setLngLat(e.lngLat)
            //         .setText(feature.properties.name)
            //         .addTo(map);
            // });

            // map.on('mouseleave', 'areas-stats', function () {
            //     map.getCanvas().style.cursor = '';
            //     popup.remove();
            //     map.setFilter('areas-stats-selected', ['in', 'id', '']);
            //     overlay.style.display = 'none';
            // });
        });
    </script>

</body>

</html>